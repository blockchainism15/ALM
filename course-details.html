<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALM Learning Object Details</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    font-family: "SF Pro Display", Arial, sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 0;
  }

  header, footer {
    background: #ffffffcc;
    text-align: center;
    padding: 12px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  footer {
    bottom: 0;
    position: fixed;
    width: 100%;
    font-size: 0.85em;
    color: #666;
  }

  .container {
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }

  .card {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
    position: relative;
  }

  .card-header {
    padding: 20px;
    position: relative;
    background-size: cover;
    background-position: center;
  }

  .card-header::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.75);
    backdrop-filter: blur(4px);
  }

  .card-header h2, .card-header p {
    position: relative;
    z-index: 2;
  }

  h2 {
    margin: 0;
    font-size: 1.6em;
  }

  .details {
    padding: 15px 20px;
  }

  .module-card {
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 10px;
    margin-top: 10px;
    padding: 10px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .module-card:hover {
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .module-header {
    display: flex;
    justify-content: space-between;
    font-weight: 500;
    color: #333;
  }

  .chapter-list {
    padding: 8px 15px;
  }

  .chapter-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
  }

  .format-label {
    font-size: 0.85em;
  }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #fff;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    padding: 20px;
    position: relative;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  .modal-header {
    font-weight: 600;
    font-size: 1.3em;
    margin-bottom: 10px;
  }

  .close-btn {
    position: absolute;
    top: 10px;
    right: 12px;
    font-size: 1.3em;
    cursor: pointer;
    color: #666;
  }
</style>
</head>

<body>
<header>
  <h2>Adobe Learning Manager - Details</h2>
</header>

<div class="container">
  <div id="content"></div>
</div>

<footer>
  Â© 2025 Adobe Learning Manager Integration
</footer>

<!-- Modal -->
<div id="resourceModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <div id="modalHeader" class="modal-header"></div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
async function loadDetails() {
  const params = new URLSearchParams(window.location.search);
  const courseId = params.get("courseId");
  if (!courseId) return;

  const type = courseId.split(":")[0];
  const apiBase = "https://cpcontents.adobe.com/eu/public/guest/eu/api/5fc01dd5-de45-408d-9b07-b267d40ebef9/9759";
  const url = `${apiBase}/${type}/${courseId.split(":")[1]}.json`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Network error");
    const data = await res.json();

    const lo = data.data;
    const inc = data.included || [];
    const attr = lo.attributes?.localizedMetadata?.[0] || {};
    const desc = attr.description || "No description available.";
    const bannerURL = lo.attributes?.bannerUrl || "";

    let html = `
      <div class="card">
        <div class="card-header" style="background-image:url('${bannerURL}')">
          <h2>${attr.name || "Untitled"}</h2>
          <p>${desc}</p>
        </div>
        <div class="details">
    `;

    // Certification-specific info
    if (type === "certification") {
      const loInstRel = lo.relationships?.instances?.data || [];
      if (loInstRel.length) {
        const loInstId = loInstRel[0].id;
        const instObj = inc.find(i => i.id === loInstId);
        if (instObj) {
          const a = instObj.attributes || {};
          let validity = a.validity || "";
          if (validity.endsWith("m")) validity = validity.slice(0, -1) + " months";

          const completionDeadline = a.completionDeadline || "";
          html += `
            <div style="margin-top:10px;padding:10px;border-top:1px solid #ddd;background:#fafafa;">
              <strong>Certification Details:</strong><br>
              <div>State: ${a.state || "N/A"}</div>
              <div>Validity: ${validity || "N/A"}</div>
              <div>Completion Deadline: ${completionDeadline || "N/A"}</div>
            </div>
          `;
        }
      }
    }

    // Sub learning objects (courses inside LP or certification)
    const subLOs = inc.filter(i => i.type === "learningObject" && i.relationships?.parentLo?.data?.id === lo.id);

    for (const sub of subLOs.length ? subLOs : [lo]) {
      const subAttr = sub.attributes?.localizedMetadata?.[0] || {};
      const subTitle = subAttr.name || "Module";
      html += `<div class="module-section"><h3>${subTitle}</h3>`;

      const subInc = inc.filter(i => i.relationships?.learningObject?.data?.id === sub.id || i.id === sub.id);
      const loInst = subInc.filter(i => i.type === "learningObjectInstance");
      const loRes = subInc.filter(i => i.type === "learningObjectResource");
      const res = subInc.filter(i => i.type === "resource");

      loInst.forEach(inst => {
        const refs = inst.relationships?.loResources?.data || [];
        const matched = loRes.filter(lr => refs.some(r => r.id === lr.id));

        matched.forEach(lr => {
          const meta = lr.attributes?.localizedMetadata?.[0];
          const moduleName = meta?.name || "Module";
          const resourceType = lr.attributes?.resourceType || "N/A";
          const resRefs = lr.relationships?.resources?.data || [];
          const related = res.filter(r => resRefs.some(rr => rr.id === r.id));

          // Always allow expand modal for all pages now
          const clickable = `onclick='showModal("${moduleName}", ${JSON.stringify(related).replace(/'/g,"&apos;")})'`;

          html += `
          <div class="module-card" ${clickable}>
            <div class="module-header">
              <span>${moduleName}</span>
              <span style="font-size:0.9em; color:#6a5acd;">${resourceType}</span>
            </div>
          </div>`;
        });
      });
      html += `</div>`;
    }

    html += `</div></div>`;
    document.getElementById("content").innerHTML = html;

  } catch (err) {
    console.error(err);
    document.getElementById("content").innerHTML = `<p style="color:red;">Failed to load course details.</p>`;
  }
}

// Modal functionality
function showModal(moduleName, resources) {
  const modal = document.getElementById("resourceModal");
  const header = document.getElementById("modalHeader");
  const body = document.getElementById("modalBody");

  header.textContent = moduleName;
  if (!resources?.length) {
    body.innerHTML = "<p>No related resources found.</p>";
  } else {
    body.innerHTML = resources.map(r => {
      const a = r.attributes || {};
      return `
        <div style="padding:8px 0;border-bottom:1px solid #eee;">
          <div><strong>Name:</strong> ${a.name || "N/A"}</div>
          <div><strong>Content Type:</strong> ${a.contentType || "N/A"}</div>
          <div><strong>Duration:</strong> ${a.desiredDuration || 0} mins</div>
        </div>`;
    }).join('');
  }

  modal.style.display = "flex";
}

function closeModal() {
  document.getElementById("resourceModal").style.display = "none";
}

window.onclick = function(e) {
  const modal = document.getElementById("resourceModal");
  if (e.target === modal) modal.style.display = "none";
};

loadDetails();
</script>
</body>
</html>
