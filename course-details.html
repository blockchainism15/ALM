<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALM Learning Object Details</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0; background: #f5f5f7; color: #333;
  }
  .container {
    max-width: 1000px; margin: 40px auto; padding: 20px;
  }
  .card {
    background: rgba(255,255,255,0.85);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    overflow: hidden;
    transition: transform 0.2s;
    position: relative;
  }
  .card:hover {
    transform: scale(1.01);
  }
  .card-header {
    position: relative;
    padding: 40px;
    color: #000;
    z-index: 2;
  }
  .card-header::before {
    content: "";
    background-size: cover;
    background-position: center;
    opacity: 0.25;
    position: absolute;
    inset: 0;
    z-index: 1;
  }
  .card-header h2, .card-header p {
    position: relative;
    z-index: 3;
  }
  .info-box {
    padding: 20px; font-size: 15px;
  }
  .module-card {
    background: rgba(255,255,255,0.9);
    margin: 12px 0;
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s;
  }
  .module-card:hover {
    transform: scale(1.02);
  }
  .module-header {
    display: flex;
    justify-content: space-between;
    padding: 15px 20px;
    background: #fff;
    border-radius: 14px 14px 0 0;
    font-weight: 600;
  }
  .chapter-list {
    padding: 10px 20px 20px;
  }
  .chapter-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 5px 0;
  }
  .format-label {
    font-size: 0.85em;
  }
  footer {
    text-align: center;
    font-size: 13px;
    color: #666;
    padding: 15px;
  }
  /* Modal styling */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background: #fff;
    margin: 8% auto;
    padding: 20px 30px;
    border-radius: 16px;
    width: 70%;
    max-width: 700px;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }
  .close {
    color: #aaa;
    position: absolute;
    right: 20px; top: 10px;
    font-size: 24px;
    cursor: pointer;
  }
  .close:hover {
    color: #000;
  }
</style>
</head>
<body>
  <div class="container" id="content"></div>

  <div id="resourceModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modalTitle"></h3>
      <div id="modalBody"></div>
    </div>
  </div>

  <footer>© 2025 Adobe Learning Manager Integration</footer>

<script>
function getFormatColor(format) {
  const colors = ['#28a745', '#ff4500', '#007bff', '#8a2be2', '#20b2aa'];
  return colors[Math.floor(Math.random() * colors.length)];
}

async function loadDetails() {
  const urlParams = new URLSearchParams(window.location.search);
  const courseId = urlParams.get('courseId');
  if (!courseId) return document.getElementById("content").innerHTML = "<p>Invalid ID</p>";

  let type = "course";
  if (courseId.startsWith("learningProgram")) type = "learningProgram";
  if (courseId.startsWith("certification")) type = "certification";

  const apiUrl = `https://cpcontents.adobe.com/eu/public/guest/eu/api/5fc01dd5-de45-408d-9b07-b267d40ebef9/9759/${type}/${courseId.split(":")[1]}.json`;

  try {
    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error("Failed");
    const data = await res.json();

    const lo = data.data;
    const inc = data.included || [];
    const attr = lo.attributes || {};
    const meta = attr.localizedMetadata?.[0] || {};
    const title = meta.name || "Untitled";
    const desc = meta.description || "No description available.";
    const banner = attr.bannerUrl || "";

    let html = `<div class="card">
      <div class="card-header" style="background-image:url('${banner}')">
        <h2>${title}</h2>
        <p>${desc}</p>`;

    if (type === "certification") {
      const rel = lo.relationships?.instances?.data?.[0]?.id;
      const instance = inc.find(i => i.id === rel && i.type === "learningObjectInstance");
      if (instance) {
        const iAttr = instance.attributes || {};
        const validity = iAttr.validity || "N/A";
        const deadline = iAttr.completionDeadline || "N/A";
        const state = iAttr.state || "N/A";
        let validText = validity.includes("m") ? validity.replace("m","") + " months" : validity;
        html += `<div class="info-box">
          <p><strong>State:</strong> ${state}</p>
          <p><strong>Validity:</strong> ${validText}</p>
          <p><strong>Completion Deadline:</strong> ${deadline}</p>
        </div>`;
      }
    }

    html += `</div><div class="info-box">`;

    // Gather sub learning objects (for LP & Certification)
    const subLos = inc.filter(i => i.type === "learningObject" && i.relationships?.parent?.data?.id === lo.id);
    if (subLos.length > 0) {
      html += `<h3>Contained Courses</h3>`;
      subLos.forEach(sub => {
        const subAttr = sub.attributes || {};
        const subMeta = subAttr.localizedMetadata?.[0] || {};
        const subName = subMeta.name || "Course";
        const subDesc = subMeta.description || "";
        html += `<div class="module-card" data-module="${sub.id}">
          <div class="module-header"><span>${subName}</span><span style="font-size:0.9em;color:#6a5acd;">Course</span></div>
          <div class="chapter-list">`;

        // link loInst → loRes → res
        const subInc = inc.filter(i => i.relationships?.learningObject?.data?.id === sub.id || i.id === sub.id);
        const loInst = subInc.filter(i => i.type === "learningObjectInstance");
        const loRes = subInc.filter(i => i.type === "learningObjectResource");
        const res = subInc.filter(i => i.type === "resource");

        loInst.forEach(inst => {
          const refs = inst.relationships?.loResources?.data || [];
          const matched = loRes.filter(lr => refs.some(r => r.id === lr.id));
          matched.forEach(lr => {
            const meta = lr.attributes?.localizedMetadata?.[0];
            const name = meta?.name || "Module";
            const resourceType = lr.attributes?.resourceType || "N/A";
            html += `<div class="chapter-item"><i class="fa-solid fa-circle-play"></i><span>${name}</span><small style="color:#20b2aa;">(${resourceType})</small></div>`;
          });
        });
        html += `</div></div>`;
      });
    }

    // top-level modules
    const loInstances = inc.filter(i => i.type === "learningObjectInstance" && i.relationships?.learningObject?.data?.id === lo.id);
    loInstances.forEach(inst => {
      const refs = inst.relationships?.loResources?.data || [];
      const loResources = inc.filter(i => i.type === "learningObjectResource" && refs.some(r => r.id === i.id));
      loResources.forEach(lr => {
        const meta = lr.attributes?.localizedMetadata?.[0];
        const name = meta?.name || "Module";
        const resourceType = lr.attributes?.resourceType || "N/A";
        const resRefs = lr.relationships?.resources?.data || [];
        const related = inc.filter(r => r.type === "resource" && resRefs.some(rr => rr.id === r.id));
        html += `
        <div class="module-card" data-module="${lr.id}">
          <div class="module-header"><span>${name}</span><span style="font-size:0.9em;color:#6a5acd;">${resourceType}</span></div>
          <div class="chapter-list">
            ${related.map(r => {
              const a = r.attributes || {};
              const t = a.contentType;
              const display = ["CP","SCORM12","SCORM2004"].includes(t) ? "Interactive" : (t || a.resourceType || "N/A");
              const color = getFormatColor(display);
              return `
              <div class="resource-card">
                <div class="chapter-item">
                  <i class="fa-solid fa-circle-play"></i>
                  <span>${a.name}</span>
                  <small class="format-label" style="color:${color};">
                    (${a.desiredDuration || 0} mins - ${display})
                  </small>
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
    });

    html += `</div></div>`;
    document.getElementById("content").innerHTML = html;

    // attach modal openers
    document.querySelectorAll(".module-card").forEach(card => {
      card.addEventListener("click", () => {
        const title = card.querySelector(".module-header span").innerText;
        const body = card.querySelector(".chapter-list").innerHTML;
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalBody").innerHTML = body;
        document.getElementById("resourceModal").style.display = "block";
      });
    });

    document.querySelector(".close").onclick = function() {
      document.getElementById("resourceModal").style.display = "none";
    };
    window.onclick = function(e) {
      if (e.target === document.getElementById("resourceModal"))
        document.getElementById("resourceModal").style.display = "none";
    };
  } catch (err) {
    document.getElementById("content").innerHTML = "<p>Failed to load course details.</p>";
  }
}
loadDetails();
</script>
</body>
</html>
