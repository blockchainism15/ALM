<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Course Details</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --blue-1: #4b6cb7;
      --purple-1: #6a11cb;
    }
    body{
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:#f4f6f8;
      margin:0;
      color:#222;
      -webkit-font-smoothing:antialiased;
    }

    /* header with banner (barely visible) */
    .page-header{
      position:relative;
      padding:28px 20px;
      text-align:center;
      overflow:hidden;
      background:linear-gradient(90deg,#003366,#0055cc);
      color:white;
    }
    .page-header .banner-bg{
      position:absolute;
      inset:0;
      background-position:center;
      background-size:cover;
      opacity:0.12; /* barely visible */
      pointer-events:none;
      z-index:0;
      filter:blur(1px);
    }
    .page-header h1{position:relative;z-index:1;margin:0;font-size:20px;font-weight:600;}

    .container{
      max-width:1100px;
      margin:22px auto;
      padding:0 18px 42px;
    }

    .card{
      background: rgba(255,255,255,0.78);
      border-radius:16px;
      border-top:3px solid rgba(77,163,255,0.9);
      border-bottom:3px solid rgba(102,51,255,0.9);
      box-shadow:0 6px 20px rgba(15,23,42,0.06);
      overflow:hidden;
      margin-bottom:18px;
    }

    .card-body{
      display:flex;
      gap:18px;
      padding:20px;
      align-items:flex-start;
    }

    .thumbnail {
      width:170px;                /* slightly bigger thumbnail as requested */
      height:110px;
      object-fit:cover;
      border-radius:12px;
      flex:0 0 170px;
      box-shadow:0 6px 18px rgba(10,20,40,0.12);
    }

    .main-meta{
      flex:1;
    }

    .main-meta h2{margin:0 0 6px;font-size:1.35rem;color:#02335e;}
    .meta-row{margin:6px 0;color:#465a6b;font-size:0.95rem;line-height:1.45}

    .register-btn{
      display:inline-block;
      padding:10px 20px;
      border-radius:999px;
      background:transparent;
      border:2px solid transparent;
      font-weight:600;
      cursor:pointer;
      margin-top:8px;
      transition:all .22s ease;
      color:var(--blue-1);
      border-image-slice:1;
      border-image-source: linear-gradient(90deg,var(--blue-1),var(--purple-1));
    }
    .register-btn:hover{
      color:white;
      background: linear-gradient(90deg,var(--blue-1),var(--purple-1));
      transform:translateY(-2px);
    }

    .card-content{
      padding: 18px 20px 26px;
    }

    .card-content h3{margin:0 0 12px;font-size:1.05rem;color:#0b3250}
    .module-card{
      background: rgba(255,255,255,0.66);
      border-radius:10px;
      padding:12px;
      border:1px solid #e6eef8;
      margin-bottom:10px;
    }

    .module-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;margin-bottom:8px;font-weight:600;color:#02335e;
    }
    .module-items{padding-left:0;margin:0}
    .module-item{
      display:flex;align-items:center;gap:10px;padding:8px 0;border-top:1px solid #f1f5f9;
    }
    .module-item:first-child{border-top:0}
    .module-item .name{flex:1;color:#234559}
    .module-item .meta{color:#687782;font-size:0.9rem;white-space:nowrap}

    .sub-lo{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:10px;border-radius:10px;background:#fbfdff;border:1px solid #eef6ff;margin-bottom:10px;
    }
    .sub-lo .left{display:flex;gap:12px;align-items:center}
    .sub-lo .sub-thumb{width:64px;height:44px;object-fit:cover;border-radius:8px}
    .badge{display:inline-block;padding:6px 8px;border-radius:8px;background:#f2f7ff;color:#0b3d72;font-weight:600;font-size:0.85rem}

    @media (max-width:820px){
      .card-body{flex-direction:column;align-items:stretch}
      .thumbnail{width:100%;height:170px;flex:unset}
    }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="banner-bg" id="bannerBg"></div>
    <h1>Learning Object Details</h1>
  </header>

  <main class="container" id="content">
    <p>Loading detailsâ€¦</p>
  </main>

<script>
(async function(){
  const content = document.getElementById('content');
  const params = new URLSearchParams(window.location.search);
  const courseIdParam = params.get('courseId');

  if(!courseIdParam){
    content.innerHTML = '<p>Invalid course ID in URL.</p>';
    return;
  }

  // Split "course:1773966" into [type, id]
  const [loType, loId] = courseIdParam.split(':');
  // Use the working API path you provided earlier
  const apiBase = 'https://cpcontents.adobe.com/eu/public/guest/eu/api/5fc01dd5-de45-408d-9b07-b267d40ebef9/9759';
  const apiUrl = `${apiBase}/${loType}/${loId}.json`;

  try{
    const res = await fetch(apiUrl);
    if(!res.ok) throw new Error('Network '+res.status);
    const payload = await res.json();

    // core attributes
    const data = payload.data || {};
    const attributes = data.attributes || {};
    const included = payload.included || [];

    // set page header banner if present (barely visible)
    const bannerUrl = attributes.bannerUrl || attributes.imageUrl || '';
    if(bannerUrl){
      const bg = document.getElementById('bannerBg');
      bg.style.backgroundImage = `url("${bannerUrl}")`;
    }

    // title/description
    const localized = (attributes.localizedMetadata && attributes.localizedMetadata[0]) || {};
    const title = localized.name || attributes.name || 'Untitled';
    const description = localized.overview || localized.description || attributes.description || 'No description available.';
    const imageUrl = attributes.imageUrl || attributes.cardImageUrl || 'https://via.placeholder.com/300x200?text=No+Image';
    const durationMain = (typeof attributes.duration === 'number') ? `${attributes.duration} mins` : (attributes.duration || 'N/A');

    // skill info: find learningObjectSkill -> find skillLevel and skill
    // We search included for learningObjectSkill => relationships.skillLevel => skillLevel id => included find
    let skillName = 'N/A', skillLevel = 'N/A', skillCredits = 'N/A';
    // find learningObjectSkill entries (they have type learningObjectSkill)
    const loSkills = included.filter(i => i.type === 'learningObjectSkill');
    if(loSkills.length){
      // take first skill relation (common case)
      const skillRel = loSkills[0];
      // skillLevel id (in its relationships)
      const skillLevelRef = skillRel.relationships?.skillLevel?.data?.id;
      // find skillLevel included
      const skillLevelObj = included.find(i => i.type==='skillLevel' && i.id===skillLevelRef);
      if(skillLevelObj){
        skillLevel = skillLevelObj.attributes?.level ?? 'N/A';
        skillCredits = skillLevelObj.attributes?.maxCredits ?? (skillLevelObj.attributes?.maxCredits === 0 ? '0' : 'N/A');
      }
      // try to find the skill object referenced by learningObjectSkill -> skill relationship is on skillLevel -> skill
      const skillObjRefId = skillLevelObj?.relationships?.skill?.data?.id;
      const skillObj = included.find(i => i.type==='skill' && i.id===skillObjRefId) || included.find(i => i.type==='skill');
      if(skillObj){
        skillName = skillObj.attributes?.name || 'N/A';
        // if skillLevel didn't give credits, try skillObj relationships levels to find maxCredits
        if(skillCredits === 'N/A'){
          const lvlRef = skillObj.relationships?.levels?.data?.[0]?.id;
          const lvlObj = included.find(i => i.type==='skillLevel' && i.id===lvlRef);
          if(lvlObj) skillCredits = lvlObj.attributes?.maxCredits ?? 'N/A';
        }
      }
    }

    // Build HTML: main card
    let html = '';
    html += `<div class="card">`;
    html +=   `<div class="card-body">`;
    html +=     `<img class="thumbnail" src="${imageUrl}" alt="thumbnail">`;
    html +=     `<div class="main-meta">`;
    html +=       `<h2>${title}</h2>`;
    html +=       `<div class="meta-row"><strong>Type:</strong> ${data.attributes?.loType || loType}</div>`;
    html +=       `<div class="meta-row"><strong>Duration:</strong> ${durationMain}</div>`;
    html +=       `<div class="meta-row"><strong>Skills:</strong> ${skillName}</div>`;
    html +=       `<div class="meta-row"><strong>Skill Level:</strong> ${skillLevel}</div>`;
    html +=       `<div class="meta-row"><strong>Skill Credits:</strong> ${skillCredits}</div>`;
    html +=       `<div style="margin-top:10px"><a class="register-btn" href="https://learningmanager.adobe.com/accountiplogin?ipId=18979&accesskey=bsni4medbhhps" target="_blank" rel="noopener">Register</a></div>`;
    html +=     `</div>`;
    html +=   `</div>`; // card-body
    html +=   `<div class="card-content">`;
    html +=     `<h3>Your Learning Journey for this ${data.attributes?.loType || loType}</h3>`;
    html +=     `<p style="margin-bottom:12px;">${description}</p>`;

    // ---- Modules for courses (use included learningObjectInstance -> learningObjectResource -> resource)
    if((data.attributes?.loType || loType) === 'course'){
      // find instances in included
      const instances = included.filter(i => i.type === 'learningObjectInstance');
      if(instances.length){
        html += `<h4 style="margin:10px 0 8px;color:#0b3d5b">Modules</h4>`;
        // loop instances (usually one default)
        for(const inst of instances){
          const loResourcesRefs = inst.relationships?.loResources?.data || [];
          // find learningObjectResource objects in included that match
          const loResources = included.filter(i => i.type === 'learningObjectResource' && loResourcesRefs.some(r=>r.id===i.id));
          if(loResources.length === 0){
            html += `<div class="module-card"><div class="module-header">No modules available</div></div>`;
          } else {
            for(const lr of loResources){
              const moduleName = (lr.attributes?.localizedMetadata && lr.attributes.localizedMetadata[0]?.name) || lr.attributes?.name || 'Module';
              // find resource objects referenced by this lr
              const resRefs = lr.relationships?.resources?.data || [];
              const relatedResources = included.filter(i => i.type==='resource' && resRefs.some(r=>r.id===i.id));
              html += `<div class="module-card">`;
              html +=   `<div class="module-header"><div>${moduleName}</div><div class="badge">${lr.attributes?.resourceType || lr.attributes?.loResourceType || 'Content'}</div></div>`;
              html +=   `<div>`;
              if(relatedResources.length){
                for(const r of relatedResources){
                  const rName = r.attributes?.name || 'Resource';
                  const rDuration = (typeof r.attributes?.desiredDuration === 'number') ? `${r.attributes.desiredDuration} mins` : (r.attributes?.desiredDuration || 'N/A');
                  const rType = r.attributes?.contentType || r.attributes?.reportingType || 'N/A';
                  html += `<div class="module-item"><div class="name">${rName}</div><div class="meta">${rType} â€¢ ${rDuration}</div></div>`;
                }
              } else {
                html += `<div class="module-item"><div class="name">No resource entries</div></div>`;
              }
              html +=   `</div>`;
              html += `</div>`;
            }
          }
        }
      } else {
        html += `<p>No modules available.</p>`;
      }
    }

    // ---- Sub learning objects (for learningProgram and certification)
    if(data.attributes?.loType === 'learningProgram' || data.attributes?.loType === 'certification'){
      const subLORefs = data.relationships?.subLOs?.data || [];
      // Sometimes included contains the sub learning objects themselves
      const subLOs = included.filter(i => i.type === 'learningObject' && subLORefs.some(ref => ref.id === i.id));
      if(subLOs.length){
        html += `<h4 style="margin:14px 0 8px;color:#0b3d5b">Included Courses</h4>`;
        for(const sub of subLOs){
          const sAttr = sub.attributes || {};
          const sMeta = (sAttr.localizedMetadata && sAttr.localizedMetadata[0]) || {};
          const sTitle = sMeta.name || sAttr.name || 'Untitled';
          const sDesc = sMeta.overview || sMeta.description || sAttr.description || '';
          const sImage = sAttr.imageUrl || '';
          const sDuration = (typeof sAttr.duration === 'number') ? `${sAttr.duration} mins` : (sAttr.duration || 'N/A');
          const sType = sAttr.loType || 'course';

          // Try to gather module/resources for this sub from included: find learningObjectInstance with relationships.learningObject pointing to this sub
          const subInstance = included.find(i => i.type==='learningObjectInstance' && i.relationships?.learningObject?.data?.id === sub.id);
          // get loResources from that instance
          let subModulesHtml = '';
          if(subInstance){
            const lrRefs = subInstance.relationships?.loResources?.data || [];
            const subLoResources = included.filter(i => i.type==='learningObjectResource' && lrRefs.some(r=>r.id===i.id));
            if(subLoResources.length){
              for(const lr of subLoResources){
                const moduleName = (lr.attributes?.localizedMetadata && lr.attributes.localizedMetadata[0]?.name) || lr.attributes?.name || 'Module';
                const resRefs = lr.relationships?.resources?.data || [];
                const relatedResources = included.filter(i => i.type==='resource' && resRefs.some(r=>r.id===i.id));
                const resourceSummaries = (relatedResources.length) ? relatedResources.map(r => {
                  const rName = r.attributes?.name || 'Resource';
                  const rDuration = (typeof r.attributes?.desiredDuration === 'number') ? `${r.attributes.desiredDuration} mins` : (r.attributes?.desiredDuration || 'N/A');
                  const rType = r.attributes?.contentType || r.attributes?.reportingType || 'N/A';
                  return `${rName} (${rType} â€¢ ${rDuration})`;
                }).join('<br>') : 'No resources';
                subModulesHtml += `<div style="font-size:0.95rem;color:#3b5566;margin-top:8px"><strong>${moduleName}</strong><div style="margin-top:6px">${resourceSummaries}</div></div>`;
              }
            }
          }

          html += `
            <div class="sub-lo">
              <div class="left">
                <img class="sub-thumb" src="${sImage || 'https://via.placeholder.com/120x80?text=No+Image'}" alt="">
                <div>
                  <div style="font-weight:700;color:#05324a">${sTitle}</div>
                  <div style="color:#556b79;font-size:0.94rem;margin-top:6px">${sDesc || 'No description available.'}</div>
                </div>
              </div>
              <div style="text-align:right">
                <div style="margin-bottom:8px"><strong>${sType}</strong></div>
                <div style="color:#687782">${sDuration}</div>
              </div>
            </div>
          `;
          if(subModulesHtml) {
            html += `<div style="margin:8px 0 14px;padding-left:8px">${subModulesHtml}</div>`;
          }
        }
      } else {
        html += `<p>No related courses available.</p>`;
      }
    }

    html += `</div></div>`; // close card-content and card

    content.innerHTML = html;

  } catch(err){
    console.error('fetch error',err);
    content.innerHTML = `<div class="card"><div class="card-body"><div><h2>Error loading details.</h2><p style="color:#666">See console for details.</p></div></div></div>`;
  }

})();
</script>
</body>
</html>
