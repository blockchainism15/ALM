<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALM Learning Object Details</title>
<style>
  body {
    font-family: 'SF Pro Display', Arial, sans-serif;
    background: linear-gradient(135deg, #dbeafe, #e0f2fe);
    margin: 0;
    padding: 0;
    color: #1e293b;
  }

  .container {
    max-width: 1100px;
    margin: 30px auto;
    background: rgba(255,255,255,0.7);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    padding: 20px;
  }

  .card-header {
    position: relative;
    background: rgba(255,255,255,0.4);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    color: #111;
    font-weight: 600;
    overflow: hidden;
  }

  .card-header::before {
    content: "";
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    opacity: 0.15;
    z-index: 0;
  }

  .card-header * {
    position: relative;
    z-index: 1;
  }

  .thumbnail {
    width: 160px;
    height: 90px;
    border-radius: 12px;
    object-fit: cover;
    margin: 15px auto;
    display: block;
  }

  .card-content {
    margin-top: 20px;
    background: rgba(255,255,255,0.7);
    border-top: 3px solid;
    border-bottom: 3px solid;
    border-image: linear-gradient(to right, #3b82f6, #a855f7) 1;
    padding: 20px;
    border-radius: 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card-content:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  }

  .register-btn {
    background: transparent;
    border: 2px solid;
    border-image: linear-gradient(to right, #3b82f6, #a855f7) 1;
    color: #1e40af;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.3s;
  }

  .register-btn:hover {
    background: linear-gradient(to right, #3b82f6, #a855f7);
    color: white;
  }

  .module-card {
    background: rgba(255,255,255,0.6);
    border-radius: 12px;
    padding: 12px 16px;
    margin: 8px 0;
    border-left: 4px solid #3b82f6;
  }

  .format-label {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 13px;
    margin-left: 10px;
  }

  .format-Interactive { color: #2563eb; font-weight: 600; }
  .format-VIDEO { color: #16a34a; font-weight: 600; }
  .format-PDF { color: #9333ea; font-weight: 600; }
  .format-DOC { color: #dc2626; font-weight: 600; }
  .format-default { color: #334155; }
</style>
</head>
<body>
<div class="container">
  <div class="card-header" id="header">
    <h2 id="title">Loading...</h2>
    <p id="description"></p>
    <img id="thumbnail" class="thumbnail" src="" alt="Course Image">
  </div>

  <div class="card-content" id="details">
    <p>Loading details...</p>
  </div>
</div>

<script>
async function fetchDetails() {
  const params = new URLSearchParams(window.location.search);
  const idParam = params.get("courseId") || params.get("learningProgramId") || params.get("certificationId");
  if (!idParam) {
    document.getElementById("details").innerHTML = "<p>No ID found in URL.</p>";
    return;
  }

  const baseURL = "https://cpcontents.adobe.com/eu/public/guest/eu/api/5fc01dd5-de45-408d-9b07-b267d40ebef9/9759/";
  const [type, id] = idParam.split(":");
  const url = `${baseURL}${type}/${id}.json`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error("Network error");
    const data = await response.json();

    const lo = data.data?.attributes || {};
    const loType = data.data?.type || "learningObject";
    const header = document.getElementById("header");
    const banner = lo.bannerUrl || "";
    header.style.setProperty("--bg-url", `url(${banner})`);
    header.querySelector("h2").textContent = lo.localizedMetadata?.[0]?.name || "Untitled";
    header.querySelector("p").textContent = lo.localizedMetadata?.[0]?.description || "No description available";
    document.getElementById("thumbnail").src = lo.imageUrl || banner || "";

    const details = document.getElementById("details");
    let html = `<h3>Your Learning Journey for this ${loType}</h3>`;
    html += `<p><strong>Title:</strong> ${lo.localizedMetadata?.[0]?.name || "Untitled"}</p>`;
    html += `<p><strong>Description:</strong> ${lo.localizedMetadata?.[0]?.description || "No description available"}</p>`;
    html += `<p><strong>Duration:</strong> ${lo.duration || "N/A"} mins</p>`;
    html += `<p><strong>Skills:</strong> ${lo.skillName || "N/A"}</p>`;
    html += `<p><strong>Skill Level:</strong> ${lo.skillLevel || "N/A"}</p>`;
    html += `<p><strong>Skill Credits:</strong> ${lo.maxCredits || "N/A"}</p>`;

    // Handle sub learning objects
    const subLOs = data.included?.filter(i => i.type.includes("learningObject")) || [];

    // For course details, show its resources
    if (type === "course") {
      const loResources = data.included?.filter(r => r.type === "learningObjectResource") || [];
      html += `<h4>Modules / Resources:</h4>`;
      for (const lr of loResources) {
        const lrAttr = lr.attributes || {};
        html += `<div class="module-card"><strong>${lrAttr.localizedMetadata?.[0]?.name || "Unnamed Module"}</strong><br>`;

        // Fetch associated resources
        const resources = data.included?.filter(r => r.type === "resource" && r.relationships?.learningObjectResource?.data?.id === lr.id) || [];
        if (resources.length) {
          html += `<div style="margin-left:15px;">`;
          for (const res of resources) {
            const rAttr = res.attributes || {};
            const formatType = (() => {
              const ct = rAttr.contentType?.toUpperCase() || "N/A";
              if (["CP", "SCORM12", "SCORM2004"].includes(ct)) return "Interactive";
              return ct;
            })();
            const colorClass = ["Interactive", "VIDEO", "PDF", "DOC"].includes(formatType)
              ? `format-${formatType}` : "format-default";
            html += `<div>- ${rAttr.name || "Unnamed Resource"} 
              <span class="format-label ${colorClass}">${formatType}</span>
              <span style="color:green;"> (${rAttr.duration || "N/A"} mins)</span>
            </div>`;
          }
          html += `</div>`;
        }
        html += `</div>`;
      }
    } 
    // For Learning Programs & Certifications: nested courses & resources
    else if (subLOs.length) {
      html += `<h4>Modules / Courses:</h4>`;
      for (const sub of subLOs) {
        const sAttr = sub.attributes || {};
        html += `<div class="module-card">
          <strong>${sAttr.localizedMetadata?.[0]?.name || "Untitled"}</strong> (${sub.type})<br>
          Duration: ${sAttr.duration || "N/A"} mins
        `;

        // Course resources
        const loResources = data.included?.filter(r => r.type === "learningObjectResource" && r.relationships?.learningObject?.data?.id === sub.id) || [];
        if (loResources.length) {
          html += `<div style="margin-left:15px;">`;
          for (const lr of loResources) {
            const lrAttr = lr.attributes || {};
            const resLinked = data.included?.filter(r => r.type === "resource" && r.relationships?.learningObjectResource?.data?.id === lr.id) || [];
            if (resLinked.length) {
              for (const res of resLinked) {
                const rAttr = res.attributes || {};
                const formatType = (() => {
                  const ct = rAttr.contentType?.toUpperCase() || "N/A";
                  if (["CP", "SCORM12", "SCORM2004"].includes(ct)) return "Interactive";
                  return ct;
                })();
                const colorClass = ["Interactive", "VIDEO", "PDF", "DOC"].includes(formatType)
                  ? `format-${formatType}` : "format-default";
                html += `<div>- ${rAttr.name || "Unnamed Resource"} 
                  <span class="format-label ${colorClass}">${formatType}</span>
                  <span style="color:green;"> (${rAttr.duration || "N/A"} mins)</span>
                </div>`;
              }
            }
          }
          html += `</div>`;
        }
        html += `</div>`;
      }
    }

    html += `<button class="register-btn">Register</button>`;
    details.innerHTML = html;

  } catch (err) {
    console.error(err);
    document.getElementById("details").innerHTML = "<p style='color:red;'>Failed to load course details.</p>";
  }
}

fetchDetails();
</script>
</body>
</html>
