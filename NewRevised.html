<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALM Learning Objects</title>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        background: linear-gradient(to bottom, #e0f0ff, #ffffff);
        margin: 0;
        padding: 20px;
    }

    h2 {
        text-align: center;
        background: linear-gradient(to right, #007bff, #00c6ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 2em;
        margin-bottom: 20px;
    }

    .filters {
        background: white;
        border-top: 4px solid #007bff;
        border-bottom: 4px solid #00c6ff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px;
        border-radius: 12px;
        justify-content: center;
    }

    select, button {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
        outline: none;
    }

    button {
        background: linear-gradient(to right, #007bff, #00c6ff);
        color: white;
        border: none;
        cursor: pointer;
        transition: 0.3s;
    }

    button:hover {
        background: linear-gradient(to right, #005ecb, #00a3d4);
    }

    #results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
        margin-top: 25px;
    }

    .card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        text-align: center;
        text-decoration: none;
        color: #000;
        border-top: 4px solid #007bff;
        border-bottom: 4px solid #00c6ff;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .rating {
        color: #ff9800;
        font-weight: bold;
    }

    #pagination {
        margin-top: 25px;
        text-align: center;
    }

    .loading {
        text-align: center;
        font-size: 18px;
        color: #007bff;
        margin-top: 30px;
    }
</style>
</head>
<body>

<h2>ALM Learning Objects</h2>

<div class="filters">
    <select id="loTypeSelect" multiple>
        <option value="course">Course</option>
        <option value="learningProgram">Learning Program</option>
        <option value="jobAid">Job Aid</option>
        <option value="certification">Certification</option>
    </select>

    <select id="deliveryTypeSelect" multiple>
        <option value="selfPaced">Self Paced</option>
        <option value="instructorLed">Instructor Led</option>
    </select>

    <select id="catalogNamesSelect" multiple></select>
    <select id="tagsSelect" multiple></select>
    <select id="loSkillNamesSelect" multiple></select>
    <select id="loSkillLevelsSelect" multiple>
        <option value="1">Level 1</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
    </select>

    <button id="applyFilters">Apply Filters</button>
    <button id="clearFilters">Clear Filters</button>
</div>

<div id="results"></div>
<div id="pagination"></div>
<div id="loading" class="loading" style="display:none;">Loading results...</div>

<script>
const accountId = "108079";
const apiKey = "9b1e6b7f-20f3-4c49-a9c8-f5f4131096f8";

const catalogs = ["Default Catalog", "Special Catalog"];
catalogs.forEach(c => document.getElementById("catalogNamesSelect").innerHTML += `<option value="${c}">${c}</option>`);

const tags = ["anu","anupam","Diagnostic"];
tags.forEach(t => document.getElementById("tagsSelect").innerHTML += `<option value="${t}">${t}</option>`);

const skills = ["Java Programming","LP SKILLS","Anupam's admin trial"];
skills.forEach(s => document.getElementById("loSkillNamesSelect").innerHTML += `<option value="${s}">${s}</option>`);

let currentPage = 0;
const pageSize = 10;

async function fetchResults(filters = {}, page = 0) {
    const container = document.getElementById("results");
    const loadingDiv = document.getElementById("loading");
    const paginationDiv = document.getElementById("pagination");
    container.innerHTML = "";
    paginationDiv.innerHTML = "";
    loadingDiv.style.display = "block";

    const apiUrl = `https://primeapps.adobe.com/almsearch/api/v1/production/${accountId}/${apiKey}/search?size=${pageSize}&from=${page * pageSize}`;

    let filterTerms = {};
    if (filters.loType?.length) filterTerms.loTypes = filters.loType;
    if (filters.deliveryType?.length) filterTerms.deliveryType = filters.deliveryType;
    if (filters.loSkillLevels?.length) filterTerms.loSkillLevels = filters.loSkillLevels;
    if (filters.loSkillNames?.length) filterTerms.loSkillNames = filters.loSkillNames;
    if (filters.catalogNames?.length) filterTerms.catalogNames = filters.catalogNames;
    if (filters.tags?.length) filterTerms.tags = filters.tags;

    const body = { query: "", filters: { terms: filterTerms }, size: pageSize };

    try {
        const res = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        loadingDiv.style.display = "none";

        if (!data.results || data.results.length === 0) {
            container.innerHTML = "<p>No results found.</p>";
            return;
        }

        data.results.forEach(lo => {
            const card = document.createElement("a");
            card.href = `course-details.html?courseId=${lo.loId}`;
            card.className = "card";
            card.target = "_blank";

            const img = document.createElement("img");
            img.src = "https://cpcontents.adobe.com/public/images/default_courses/2.png";
            card.appendChild(img);

            const h4 = document.createElement("h4");
            h4.textContent = lo.name;
            card.appendChild(h4);

            const typeP = document.createElement("p");
            typeP.textContent = `${lo.loType} | ${lo.deliveryType || "N/A"} | Duration: ${lo.duration || "N/A"} mins`;
            card.appendChild(typeP);

            const skillsP = document.createElement("p");
            skillsP.textContent = "Skills: " + (lo.loSkillNames?.join(", ") || "N/A");
            card.appendChild(skillsP);

            const ratingP = document.createElement("p");
            ratingP.innerHTML = `Rating: <span class="rating">${lo.averageRating || 0}â˜…</span> (${lo.ratingsCount || 0})`;
            card.appendChild(ratingP);

            container.appendChild(card);

            // Async fetch image
            const numericId = lo.loId.split(":")[1];
            fetch(`https://cpcontents.adobe.com/public/guest/production/api/${apiKey}/${accountId}/course/${numericId}.json`)
                .then(res => res.json())
                .then(detail => {
                    if (detail?.data?.attributes?.imageUrl) {
                        img.src = detail.data.attributes.imageUrl;
                    }
                })
                .catch(() => {});
        });

        // Pagination controls
        paginationDiv.innerHTML = `
            <button ${page === 0 ? "disabled" : ""} onclick="changePage(${page - 1})">Previous</button>
            <button onclick="changePage(${page + 1})">Next</button>
        `;

    } catch (err) {
        console.error(err);
        document.getElementById("results").innerHTML = "<p>Error fetching results.</p>";
        loadingDiv.style.display = "none";
    }
}

function changePage(newPage) {
    currentPage = newPage;
    const filters = getFilters();
    fetchResults(filters, currentPage);
}

function getFilters() {
    return {
        loType: Array.from(document.getElementById("loTypeSelect").selectedOptions).map(o => o.value),
        deliveryType: Array.from(document.getElementById("deliveryTypeSelect").selectedOptions).map(o => o.value),
        loSkillLevels: Array.from(document.getElementById("loSkillLevelsSelect").selectedOptions).map(o => o.value),
        loSkillNames: Array.from(document.getElementById("loSkillNamesSelect").selectedOptions).map(o => o.value),
        catalogNames: Array.from(document.getElementById("catalogNamesSelect").selectedOptions).map(o => o.value),
        tags: Array.from(document.getElementById("tagsSelect").selectedOptions).map(o => o.value)
    };
}

document.getElementById("applyFilters").addEventListener("click", () => {
    currentPage = 0;
    fetchResults(getFilters());
});

document.getElementById("clearFilters").addEventListener("click", () => {
    document.querySelectorAll("select").forEach(sel => sel.selectedIndex = -1);
    currentPage = 0;
    fetchResults({});
});

fetchResults({});
</script>

</body>
</html>
