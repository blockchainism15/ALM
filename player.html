<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ALM - Custom Embedded Player</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#6ee7b7;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.04);
      --control-size:44px;
    }
    *{box-sizing:border-box;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    body{margin:0;background:linear-gradient(180deg,#061026 0%, #071226 60%);color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
    .player-shell{width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .stage{
      background:linear-gradient(180deg,#061224,#02101a);
      border-radius:10px;overflow:hidden;height:560px;position:relative;display:flex;flex-direction:column}
    .stage .player-viewport{flex:1;display:flex;align-items:center;justify-content:center;background:var(--glass)}
    #alm-player-frame{width:100%;height:100%;display:block;border:0}
    /* controls */
    .controls{
      display:flex;align-items:center;gap:12px;padding:12px 14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));border-top:1px solid rgba(255,255,255,0.02)
    }
    .left, .center, .right{display:flex;align-items:center;gap:10px}
    .left{flex:0 0 auto}
    .center{flex:1;gap:12px;align-items:center}
    .right{flex:0 0 auto}
    .btn {
      width:var(--control-size);height:var(--control-size);border-radius:10px;border:0;background:linear-gradient(180deg,#0b1220,#07101a);color:var(--accent);display:inline-flex;align-items:center;justify-content:center;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.45)
    }
    .btn.secondary{width:auto;padding:8px 10px;height:auto;border-radius:8px;background:transparent;color:var(--muted);font-weight:500}
    .btn svg{width:20px;height:20px;display:block}
    .time{font-variant-numeric:tabular-nums;color:var(--muted);font-size:13px}
    .progress-wrap{display:flex;align-items:center;gap:10px;width:100%}
    .progress{
      -webkit-appearance:none;background:linear-gradient(90deg,#0b1220,#07101a);height:8px;border-radius:999px;width:100%;outline:none;cursor:pointer;border:1px solid rgba(255,255,255,0.02)
    }
    .progress::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 3px 10px rgba(110,231,183,0.12);margin-top:-3px}
    .vol-slider{width:110px}
    .select, .toggle{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;color:var(--muted)}
    .status{font-size:12px;color:var(--muted);padding-left:8px}
    .meta{display:flex;align-items:center;gap:12px;padding:10px 4px;color:var(--muted);font-size:13px}
    .logo{font-weight:700;color:var(--accent)}
    /* responsive */
    @media (max-width:880px){
      .stage{height:420px}
      :root{--control-size:38px}
      .vol-slider{width:70px}
    }
  </style>
</head>
<body>
  <div class="player-shell" role="application" aria-label="Custom ALM Embedded Player">
    <div class="meta">
      <div class="logo">ALM Custom Player</div>
      <div class="status" id="playerStatus">status: idle</div>
      <div style="flex:1"></div>
      <div id="notesIndicator" class="status">notes: off</div>
      <div id="tocIndicator" class="status">toc: hidden</div>
    </div>

    <div class="stage" aria-hidden="false">
      <div class="player-viewport" id="playerViewport">
        <!-- The embedded player will be injected into #alm-player-frame -->
        <div id="alm-player-frame" aria-label="ALM player container"></div>
        <!-- Fallback HTML5 video will be injected when cpPlayerLib isn't available -->
      </div>

      <div class="controls" role="group" aria-label="player controls">
        <div class="left">
          <button class="btn" id="prevBtn" title="Previous"><svg viewBox="0 0 24 24" fill="none"><path d="M11 18V6l-8 6 8 6zM22 6v12h-2V6h2z" fill="currentColor"/></svg></button>
          <button class="btn" id="playPauseBtn" title="Play/Pause"><svg viewBox="0 0 24 24" id="playIcon" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
          <button class="btn" id="nextBtn" title="Next"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 6v12l8-6-8-6zM4 6h2v12H4z"/></svg></button>
          <div class="time" id="timeDisplay">00:00 / 00:00</div>
        </div>

        <div class="center">
          <div class="progress-wrap" aria-hidden="false">
            <input type="range" id="progress" min="0" max="1000" value="0" class="progress" aria-label="Seek"/>
          </div>
        </div>

        <div class="right">
          <button class="btn secondary" id="tocToggle">TOC</button>
          <button class="btn secondary" id="notesToggle">Notes</button>
          <button class="btn" id="ccToggle" title="Closed captions"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 4H3v16h18V4zM7.75 14.5H6.25V9.5h1.5v2.5h.75c.77 0 1.5.54 1.5 1.5s-.73 1.5-1.5 1.5zM15.75 14.5h-1.5V12h-1.25V9.5h2.75c.83 0 1.75.6 1.75 1.5v1.5c0 .9-.92 1.5-1.75 1.5z"/></svg></button>
          <input id="volume" class="vol-slider" type="range" min="0" max="1" step="0.01" value="0.9" aria-label="Volume"/>
          <select id="languageSelect" class="select" aria-label="Change language">
            <option value="">Language</option>
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
          </select>
        </div>
      </div>
    </div>
    <div style="margin-top:12px;color:var(--muted);font-size:13px">
      Tip: this file already includes accountId and userId you provided. The embedded ALM player library is loaded from Adobe's public CDN (see script tag below).
      If you still see the fallback video, open DevTools console to see startPlayer errors.
    </div>
  </div>

  <!-- Adobe player interaction library (public CDN you provided) -->
  <script src="https://cpcontents.adobe.com/public/publiccdn/playerInteractionLib.min.js"></script>

  <script>
    /* ALM Embedded Player Integration + UI glue code
       - Defaults filled with the values you provided:
         loId: course:3956416
         module_id: course:3956416_4396960_10446150_0
         instance_id: course:3956416_4396960
         accessToken: a50505b3077da52c4818ac81b2d94987
         accountId: 108079
         userId: 15263446
       - The script will attempt to use the Adobe cpPlayerLib.startPlayer API. If cpPlayerLib is not available
         or startPlayer fails, a fallback HTML5 video is used so you can confirm UI behavior locally.
       - NOTE: Exposing access tokens in client-side code is a security risk. For production, obtain tokens server-side and inject securely.
    */

    (function(){
      const el = id => document.getElementById(id);
      const playPauseBtn = el('playPauseBtn');
      const prevBtn = el('prevBtn');
      const nextBtn = el('nextBtn');
      const progress = el('progress');
      const timeDisplay = el('timeDisplay');
      const volume = el('volume');
      const tocToggle = el('tocToggle');
      const notesToggle = el('notesToggle');
      const ccToggle = el('ccToggle');
      const languageSelect = el('languageSelect');
      const playerStatus = el('playerStatus');
      const notesIndicator = el('notesIndicator');
      const tocIndicator = el('tocIndicator');
      const frameContainer = el('alm-player-frame');
      let playerObj = null;
      let usingEmbedded = false;
      let fallbackVideo = null;
      let isPlaying = false;
      let updateTimer = null;

      function setStatus(text){
        playerStatus.textContent = 'status: ' + text;
        console.debug('[ALM PLAYER STATUS]', text);
      }

      function formatTime(s){
        if(!isFinite(s)) return '00:00';
        s = Math.floor(s);
        const mm = Math.floor(s/60);
        const ss = s%60;
        return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
      }

      function bindFallbackVideo(){
        frameContainer.innerHTML = '';
        const v = document.createElement('video');
        v.controls = false;
        v.style.width = '100%';
        v.style.height = '100%';
        v.style.objectFit = 'contain';
        v.src = 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4';
        v.crossOrigin = 'anonymous';
        frameContainer.appendChild(v);
        fallbackVideo = v;
        v.volume = parseFloat(volume.value);
        v.addEventListener('timeupdate', () => {
          const pct = v.duration ? (v.currentTime / v.duration) * 1000 : 0;
          progress.value = Math.max(0, Math.min(1000, pct));
          timeDisplay.textContent = `${formatTime(v.currentTime)} / ${formatTime(v.duration)}`;
        });
        v.addEventListener('play', () => { isPlaying = true; updatePlayIcon(); setStatus('playing (fallback)'); });
        v.addEventListener('pause', () => { isPlaying = false; updatePlayIcon(); setStatus('paused (fallback)'); });
        v.addEventListener('ended', () => { isPlaying = false; updatePlayIcon(); setStatus('ended (fallback)'); });
        setStatus('fallback video ready');
      }

      function updatePlayIcon(){
        const playIcon = document.getElementById('playIcon');
        playIcon.innerHTML = isPlaying ? '<path d="M6 19h4V5H6v14zM14 5v14h4V5h-4z"/>' : '<path d="M8 5v14l11-7z"/>';
      }

      // PostMessage helper (tries iframe first, then playerObj.postMessage)
      function postMessageToPlayer(msg){
        const iframe = frameContainer.querySelector('iframe');
        if(iframe && iframe.contentWindow) {
          try { iframe.contentWindow.postMessage(msg, '*'); return; } catch(e) { console.warn('postMessage iframe error', e); }
        }
        if(playerObj && typeof playerObj.postMessage === 'function') {
          try { playerObj.postMessage(msg); return; } catch(e) { console.warn('playerObj.postMessage error', e); }
        }
        console.warn('no iframe/player to post message to, msg:', msg);
      }

      function tryStartEmbedded(params){
        // If cpPlayerLib isn't yet available, wait until it's ready (the library script tag above should load)
        if(!(window.cpPlayerLib && typeof window.cpPlayerLib.startPlayer === 'function')){
          setStatus('waiting for cpPlayerLib to load...');
          // Poll a short while for the library to load
          let attempts = 0;
          const poll = setInterval(() => {
            attempts++;
            if(window.cpPlayerLib && typeof window.cpPlayerLib.startPlayer === 'function'){
              clearInterval(poll);
              startEmbeddedNow(params);
            } else if(attempts > 30){
              clearInterval(poll);
              setStatus('embedded library not found (falling back)');
              bindFallbackVideo();
            }
          }, 300);
          return;
        }
        // library already present
        startEmbeddedNow(params);
      }

      function startEmbeddedNow(params){
        // Set env/sourceOrigin as recommended
        try {
          window.cpPlayerLib.env = window.cpPlayerLib.env || 'https://learningmanager.adobe.com/app/player';
          window.cpPlayerLib.sourceOrigin = window.cpPlayerLib.sourceOrigin || 'https://cpcontents.adobe.com';
        } catch(e){
          console.warn('Could not set cpPlayerLib env/sourceOrigin', e);
        }

        setStatus('starting embedded player...');
        const domRefId = 'alm-player-frame';

        // Use the supplied parameters (defaults filled)
        const loId = params.loId || 'course:3956416';
        const moduleId = params.module_id || 'course:3956416_4396960_10446150_0';
        const instanceId = params.instance_id || 'course:3956416_4396960';
        const accountId = params.accountId || params.account_id || '108079';
        const userId = params.userId || params.user_id || '15263446';
        const accessToken = params.accessToken || params.access_token || 'a50505b3077da52c4818ac81b2d94987';

        console.info('startPlayer parameters', { loId, moduleId, instanceId, accountId, userId, accessTokenProvided: !!accessToken });

        // Start player
        window.cpPlayerLib.startPlayer(loId, accountId, userId, accessToken, domRefId)
          .then(obj => {
            playerObj = obj;
            usingEmbedded = true;
            setStatus('embedded ready');

            // Attempt to navigate to module if API available; else send message
            try {
              if(moduleId) {
                if(playerObj.navigateToModule) {
                  playerObj.navigateToModule(moduleId);
                  setStatus('navigated to module (embedded)');
                } else {
                  postMessageToPlayer({ type: 'player:navigateToModule', moduleId, instanceId });
                  setStatus('requested module navigation via message');
                }
              }
            } catch (navErr) {
              console.warn('module navigation failed', navErr);
            }

            wireEmbeddedAPIs();
          })
          .catch(err => {
            console.error('startPlayer failed', err);
            setStatus('embedded start failed (falling back)');
            bindFallbackVideo();
          });
      }

      function wireEmbeddedAPIs(){
        if(!playerObj) return;

        prevBtn.addEventListener('click', () => {
          if(playerObj.previous) { playerObj.previous(); setStatus('previous (embedded)'); }
          else postMessageToPlayer({ type: 'navigate', action: 'previous' });
        });
        nextBtn.addEventListener('click', () => {
          if(playerObj.next) { playerObj.next(); setStatus('next (embedded)'); }
          else postMessageToPlayer({ type: 'navigate', action: 'next' });
        });

        tocToggle.addEventListener('click', () => {
          if(playerObj.toggleTOC) { playerObj.toggleTOC(); setStatus('toggle toc (embedded)'); toggleIndicator(tocIndicator); }
          else postMessageToPlayer({ type:'player:toggleTOC' });
        });

        notesToggle.addEventListener('click', () => {
          if(playerObj.toggleNotes) { playerObj.toggleNotes(); setStatus('toggle notes (embedded)'); toggleIndicator(notesIndicator); }
          else postMessageToPlayer({ type:'player:toggleNotes' });
        });

        ccToggle.addEventListener('click', () => {
          if(playerObj.toggleClosedCaption) { playerObj.toggleClosedCaption(); setStatus('toggle captions (embedded)'); }
          else postMessageToPlayer({ type:'player:toggleCC' });
        });

        languageSelect.addEventListener('change', (e) => {
          const lang = e.target.value;
          if(!lang) return;
          if(playerObj.changeLanguage) { playerObj.changeLanguage(lang); setStatus('language: '+lang); }
          else postMessageToPlayer({ type:'player:changeLanguage', lang });
        });

        playPauseBtn.addEventListener('click', () => {
          if(playerObj.play && playerObj.pause){
            if(playerObj.isPlaying && playerObj.isPlaying()){
              playerObj.pause();
              setStatus('paused (embedded)');
            } else {
              playerObj.play();
              setStatus('playing (embedded)');
            }
          } else {
            postMessageToPlayer({ type:'player:togglePlay' });
            setStatus('toggle play (message to embedded)');
          }
        });

        // Seek/progress
        progress.addEventListener('input', (e) => {
          // UI feedback
          timeDisplay.textContent = 'seeking...';
        });
        progress.addEventListener('change', (e) => {
          const pct = parseFloat(e.target.value)/1000.0;
          if(playerObj.seekTo) {
            try { playerObj.seekTo(pct); setStatus('seek (embedded)'); }
            catch(e) { postMessageToPlayer({ type:'player:seek', pct }); setStatus('seek (message)'); }
          } else {
            postMessageToPlayer({ type:'player:seek', pct });
          }
        });

        volume.addEventListener('input', (e) => {
          const v = parseFloat(e.target.value);
          if(playerObj.setVolume) playerObj.setVolume(v);
          else postMessageToPlayer({ type:'player:setVolume', v });
        });

        window.addEventListener('message', (ev) => {
          try{
            const d = ev.data;
            if(!d || typeof d !== 'object') return;
            if(d.type === 'player:stateUpdate') {
              if(d.currentTime != null && d.duration != null){
                const pct = d.duration ? (d.currentTime / d.duration)*1000 : 0;
                if(!progress.matches(':active')) progress.value = Math.max(0, Math.min(1000, pct));
                timeDisplay.textContent = `${formatTime(d.currentTime)} / ${formatTime(d.duration)}`;
              }
              isPlaying = !!d.isPlaying;
              updatePlayIcon();
              if(d.captionsOn != null) {
                ccToggle.classList.toggle('active', !!d.captionsOn);
              }
            }
            if(d.type === 'player:tocStatus') {
              tocIndicator.textContent = 'toc: ' + (d.open ? 'shown':'hidden');
            }
            if(d.type === 'player:notesStatus') {
              notesIndicator.textContent = 'notes: ' + (d.open ? 'on':'off');
            }
          }catch(e){ /* ignore */ }
        });

        setStatus('embedded controls bound');
      }

      function toggleIndicator(node){
        if(node === notesIndicator){
          node.textContent = node.textContent.includes('on') ? 'notes: off' : 'notes: on';
        } else {
          node.textContent = node.textContent.includes('hidden') ? 'toc: shown' : 'toc: hidden';
        }
      }

      // Fallback UI handlers
      prevBtn.addEventListener('click', () => {
        if(usingEmbedded || !fallbackVideo) return;
        fallbackVideo.currentTime = Math.max(0, fallbackVideo.currentTime - 10);
      });

      nextBtn.addEventListener('click', () => {
        if(usingEmbedded || !fallbackVideo) return;
        fallbackVideo.currentTime = Math.min(fallbackVideo.duration || 0, fallbackVideo.currentTime + 10);
      });

      playPauseBtn.addEventListener('click', () => {
        if(usingEmbedded) return;
        if(!fallbackVideo) return;
        if(fallbackVideo.paused) { fallbackVideo.play(); } else { fallbackVideo.pause(); }
      });

      progress.addEventListener('input', (e) => {
        if(usingEmbedded) return;
        if(!fallbackVideo || !fallbackVideo.duration) return;
        timeDisplay.textContent = '...';
      });

      progress.addEventListener('change', (e) => {
        if(usingEmbedded) return;
        if(!fallbackVideo || !fallbackVideo.duration) return;
        const pct = parseFloat(e.target.value)/1000.0;
        fallbackVideo.currentTime = (fallbackVideo.duration || 0) * pct;
      });

      volume.addEventListener('input', (e) => {
        if(usingEmbedded) return;
        if(fallbackVideo) fallbackVideo.volume = parseFloat(e.target.value);
      });

      // Initialize
      (function init(){
        setStatus('initializing');

        // Defaults (your provided values)
        const defaults = {
          loId: 'course:3956416',
          module_id: 'course:3956416_4396960_10446150_0',
          instance_id: 'course:3956416_4396960',
          accessToken: 'a50505b3077da52c4818ac81b2d94987',
          accountId: '108079',
          userId: '15263446'
        };

        // Merge with query string overrides (so you can still pass different values via URL)
        const q = {};
        location.search.replace(/^\?/, '').split('&').forEach(part => {
          if(!part) return;
          const [k,v] = part.split('=');
          q[decodeURIComponent(k)] = decodeURIComponent(v || '');
        });
        const params = Object.assign({}, defaults, q);

        // Start the embedded player (or fallback)
        tryStartEmbedded(params);

        // Keep UI time updater for fallback video
        updateTimer = setInterval(() => {
          if(!usingEmbedded && fallbackVideo){
            if(fallbackVideo.duration){
              const pct = (fallbackVideo.currentTime / fallbackVideo.duration) * 1000;
              progress.value = Math.max(0, Math.min(1000, pct));
              timeDisplay.textContent = `${formatTime(fallbackVideo.currentTime)} / ${formatTime(fallbackVideo.duration)}`;
            }
          }
        }, 300);
      })();
    })();
  </script>
</body>
</html>
