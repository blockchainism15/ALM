<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALM Learning Objects</title>
<style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    .filters { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    select, button { padding:5px 10px; }
    #results { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; }
    .card { background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; text-align:center; text-decoration:none; color:#000; transition: transform 0.2s; }
    .card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.2); }
    .card img { width:100%; height:150px; object-fit:cover; border-radius:4px; margin-bottom:10px; }
    .rating { color: #ff9800; font-weight:bold; }
</style>
</head>
<body>

<h2>ALM Learning Objects</h2>

<div class="filters">
    <select id="loTypeSelect" multiple>
        <option value="course">Course</option>
        <option value="learningProgram">Learning Program</option>
        <option value="jobAid">Job Aid</option>
        <option value="certification">Certification</option>
    </select>

    <select id="deliveryTypeSelect" multiple>
        <option value="Self Paced">Self Paced</option>
        <option value="Instructor Led">Instructor Led</option>
    </select>

    <select id="catalogNamesSelect" multiple></select>
    <select id="tagsSelect" multiple></select>
    <select id="loSkillNamesSelect" multiple></select>
    <select id="loSkillLevelsSelect" multiple>
        <option value="1">Level 1</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
    </select>

    <button id="applyFilters">Apply Filters</button>
    <button id="clearFilters">Clear Filters</button>
</div>

<div id="results"></div>

<script>
const accountId = "108079"; // your account id
const apiKey = "9b1e6b7f-20f3-4c49-a9c8-f5f4131096f8"; // your API key

// Populate catalogs, tags, skills dynamically (optional: replace with your API)
const catalogs = ["Default Catalog", "Special Catalog"];
catalogs.forEach(c => document.getElementById("catalogNamesSelect").innerHTML += `<option value="${c}">${c}</option>`);

const tags = ["anu","anupam","Diagnostic"];
tags.forEach(t => document.getElementById("tagsSelect").innerHTML += `<option value="${t}">${t}</option>`);

const skills = ["Java Programming","LP SKILLS","Anupam's admin trial"];
skills.forEach(s => document.getElementById("loSkillNamesSelect").innerHTML += `<option value="${s}">${s}</option>`);

// Fetch results from ALM Search API
async function fetchResults(filters={}) {
    const apiUrl = `https://primeapps.adobe.com/almsearch/api/v1/production/${accountId}/${apiKey}/search?size=50`;

    let filterTerms = {};
    if(filters.loType?.length) filterTerms.loTypes = filters.loType;
    if(filters.deliveryType?.length) filterTerms.deliveryType = filters.deliveryType;
    if(filters.loSkillLevels?.length) filterTerms.loSkillLevels = filters.loSkillLevels;
    if(filters.loSkillNames?.length) filterTerms.loSkillNames = filters.loSkillNames;
    if(filters.catalogNames?.length) filterTerms.catalogNames = filters.catalogNames;
    if(filters.tags?.length) filterTerms.tags = filters.tags;

    const body = { query:"", filters:{ terms: filterTerms }, size:50 };

    try {
        const res = await fetch(apiUrl, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        const container = document.getElementById("results");
        container.innerHTML = "";

        if(!data.results || data.results.length===0) {
            container.innerHTML = "<p>No results found for selected filters.</p>";
            return;
        }

        data.results.forEach(async lo => {
            const card = document.createElement("a");
            card.href = "#";
            card.target = "_blank";
            card.className = "card";

            const img = document.createElement("img");
            img.src = "https://cpcontents.adobe.com/public/images/default_courses/2.png"; // default
            card.appendChild(img);

            const h4 = document.createElement("h4");
            h4.textContent = lo.name;
            card.appendChild(h4);

            const typeP = document.createElement("p");
            typeP.textContent = `${lo.loType} | ${lo.deliveryType || "N/A"} | Duration: ${lo.duration || "N/A"} mins`;
            card.appendChild(typeP);

            const skillsP = document.createElement("p");
            skillsP.textContent = "Skills: " + (lo.loSkillNames?.join(", ") || "N/A");
            card.appendChild(skillsP);

            const ratingP = document.createElement("p");
            ratingP.innerHTML = `Rating: <span class="rating">${lo.averageRating || 0}â˜…</span> (${lo.ratingsCount || 0})`;
            card.appendChild(ratingP);

            container.appendChild(card);

            // Fetch detailed LO image asynchronously
            const numericId = lo.loId.split(":")[1];
            try {
                const detailRes = await fetch(`https://cpcontents.adobe.com/public/guest/production/api/${apiKey}/${accountId}/course/${numericId}.json`);
                const detailData = await detailRes.json();
                if(detailData?.data?.attributes?.imageUrl){
                    img.src = detailData.data.attributes.imageUrl;
                }
            } catch(e) {
                console.warn("Failed to fetch LO details:", lo.loId);
            }
        });

    } catch(err){
        console.error(err);
        document.getElementById("results").innerHTML = "<p>Error fetching results.</p>";
    }
}

// Event listeners for filters
document.getElementById("applyFilters").addEventListener("click", () => {
    const filters = {
        loType: Array.from(document.getElementById("loTypeSelect").selectedOptions).map(o=>o.value),
        deliveryType: Array.from(document.getElementById("deliveryTypeSelect").selectedOptions).map(o=>o.value),
        loSkillLevels: Array.from(document.getElementById("loSkillLevelsSelect").selectedOptions).map(o=>o.value),
        loSkillNames: Array.from(document.getElementById("loSkillNamesSelect").selectedOptions).map(o=>o.value),
        catalogNames: Array.from(document.getElementById("catalogNamesSelect").selectedOptions).map(o=>o.value),
        tags: Array.from(document.getElementById("tagsSelect").selectedOptions).map(o=>o.value)
    };
    fetchResults(filters);
});

document.getElementById("clearFilters").addEventListener("click", () => {
    document.querySelectorAll("select").forEach(sel => sel.selectedIndex=-1);
    fetchResults({});
});

// Initial load
fetchResults({});
</script>

</body>
</html>
